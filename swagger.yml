openapi: 3.0.0
info:
  title: ImageMagick API
  description: RESTful API wrapper for ImageMagick functionality with browser-based testing
  version: 1.0.0
  contact:
    name: API Support
  license:
    name: MIT

servers:
  - url: "{protocol}://{host}:{port}"
    description: Configurable server
    variables:
      protocol:
        default: http
        enum:
          - http
          - https
        description: HTTP protocol
      host:
        default: localhost
        description: Server hostname or IP address
      port:
        default: "3000"
        description: Server port
  - url: http://localhost:3000
    description: Local development server

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Optional API token authentication (only if API_TOKEN is set)

  schemas:
    SuccessResponse:
      type: object
      properties:
        success:
          type: integer
          enum: [1]
          description: Success indicator
        image:
          type: string
          format: byte
          description: Base64 encoded image data
        mimetype:
          type: string
          description: MIME type of the output image (e.g., image/png, image/jpeg)
        format:
          type: string
          description: Output image format
      required:
        - success
        - image

    ErrorResponse:
      type: object
      properties:
        success:
          type: integer
          enum: [0]
          description: Error indicator
        errormessage:
          type: string
          description: Error description
      required:
        - success
        - errormessage

    HealthResponse:
      type: object
      properties:
        success:
          type: integer
          enum: [1]
        status:
          type: string
        timestamp:
          type: string
          format: date-time
        uptime:
          type: number

security:
  - BearerAuth: []
  - {}

paths:
  /health:
    get:
      tags:
        - System
      summary: Health check endpoint
      description: Check if the API is running and healthy
      security: []
      responses:
        "200":
          description: API is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /:
    get:
      tags:
        - System
      summary: API information
      description: Get information about available endpoints
      responses:
        "200":
          description: API information retrieved successfully
          content:
            application/json:
              schema:
                type: object

  /terminal:
    post:
      tags:
        - Image Processing
      summary: Apply terminal dithering effect
      description: Apply Floyd-Steinberg dithering for terminal display (creates a 1-bit black/white effect)
      parameters:
        - name: responseMode
          in: query
          description: Response format mode
          required: false
          schema:
            type: string
            enum: [base64, binary]
            default: base64
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                image:
                  type: string
                  format: binary
                  description: Image file to process
              required:
                - image
      responses:
        "200":
          description: Image processed successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      effect:
                        type: string
                        example: terminal-dithering
              description: Returned when responseMode=base64 (default)
            image/*:
              schema:
                type: string
                format: binary
              description: |
                Returned when responseMode=binary. Raw binary image data with metadata in HTTP headers:
                - Content-Type: image/* (image/png, image/jpeg, etc.)
                - X-Image-Mimetype: image/png (matches Content-Type)
                - X-Image-Format: png
                - X-Image-Effect: terminal-dithering
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /resize:
    post:
      tags:
        - Image Processing
      summary: Resize image
      description: |
        Resize image with optional aspect ratio preservation. Output format will match input format.
        - Both width and height: Exact dimensions (may distort)
        - Only width: Height calculated automatically
        - Only height: Width calculated automatically
      parameters:
        - name: responseMode
          in: query
          description: Response format mode
          required: false
          schema:
            type: string
            enum: [base64, binary]
            default: base64
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                image:
                  type: string
                  format: binary
                  description: Image file to resize
                width:
                  type: integer
                  minimum: 1
                  description: Target width in pixels (optional if height provided)
                  example: 800
                height:
                  type: integer
                  minimum: 1
                  description: Target height in pixels (optional if width provided)
                  example: 600
              required:
                - image
      responses:
        "200":
          description: Image resized successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      width:
                        type: string
                      height:
                        type: string
              description: Returned when responseMode=base64 (default)
            image/*:
              schema:
                type: string
                format: binary
              description: |
                Returned when responseMode=binary. Raw binary image data with metadata in HTTP headers:
                - Content-Type: image/* (image/png, image/jpeg, etc.)
                - X-Image-Mimetype: image/png (matches Content-Type)
                - X-Image-Format: png
                - X-Image-Width: 800 (or "auto")
                - X-Image-Height: 600 (or "auto")
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /convert:
    post:
      tags:
        - Image Processing
      summary: Convert image format
      description: Convert image between different formats with optional quality control
      parameters:
        - name: responseMode
          in: query
          description: Response format mode
          required: false
          schema:
            type: string
            enum: [base64, binary]
            default: base64
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                image:
                  type: string
                  format: binary
                  description: Image file to convert
                format:
                  type: string
                  enum: [png, jpg, jpeg, webp, gif, bmp, tiff, svg]
                  description: Target output format
                  example: jpg
                quality:
                  type: integer
                  minimum: 1
                  maximum: 100
                  description: Quality for lossy formats like JPG/WebP (1-100)
                  example: 85
              required:
                - image
                - format
      responses:
        "200":
          description: Image converted successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      quality:
                        type: string
              description: Returned when responseMode=base64 (default)
            image/*:
              schema:
                type: string
                format: binary
              description: |
                Returned when responseMode=binary. Raw binary image data with metadata in HTTP headers:
                - Content-Type: image/* (image/png, image/jpeg, etc.)
                - X-Image-Mimetype: image/png (matches Content-Type)
                - X-Image-Format: jpg
                - X-Image-Quality: 85 (or "default")
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /rotate:
    post:
      tags:
        - Image Processing
      summary: Rotate or flip image
      description: |
        Rotate image by degrees or flip horizontally/vertically. Output format will match input format.
        - Rotate: 90, 180, 270 degrees
        - Flip: horizontal or vertical
      parameters:
        - name: responseMode
          in: query
          description: Response format mode
          required: false
          schema:
            type: string
            enum: [base64, binary]
            default: base64
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                image:
                  type: string
                  format: binary
                  description: Image file to transform
                operation:
                  type: string
                  enum: [rotate, flip]
                  description: Type of operation
                  example: rotate
                value:
                  type: string
                  description: For rotate (90, 180, 270), for flip (horizontal, vertical)
                  example: "90"
              required:
                - image
                - operation
                - value
      responses:
        "200":
          description: Image transformed successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      operation:
                        type: string
                      value:
                        type: string
              description: Returned when responseMode=base64 (default)
            image/*:
              schema:
                type: string
                format: binary
              description: |
                Returned when responseMode=binary. Raw binary image data with metadata in HTTP headers:
                - Content-Type: image/* (image/png, image/jpeg, etc.)
                - X-Image-Mimetype: image/png (matches Content-Type)
                - X-Image-Format: png
                - X-Image-Operation: rotate
                - X-Image-Value: 90
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /crop:
    post:
      tags:
        - Image Processing
      summary: Crop image
      description: |
        Crop image manually or auto-trim borders. Output format will match input format.
        - Manual mode: Specify exact crop dimensions and position
        - Trim mode: Automatically remove transparent/white borders
      parameters:
        - name: responseMode
          in: query
          description: Response format mode
          required: false
          schema:
            type: string
            enum: [base64, binary]
            default: base64
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                image:
                  type: string
                  format: binary
                  description: Image file to crop
                mode:
                  type: string
                  enum: [manual, trim]
                  description: Crop mode
                  example: manual
                width:
                  type: integer
                  minimum: 1
                  description: Crop width in pixels (required for manual mode)
                  example: 500
                height:
                  type: integer
                  minimum: 1
                  description: Crop height in pixels (required for manual mode)
                  example: 500
                x:
                  type: integer
                  minimum: 0
                  description: X offset in pixels (required for manual mode)
                  example: 0
                y:
                  type: integer
                  minimum: 0
                  description: Y offset in pixels (required for manual mode)
                  example: 0
              required:
                - image
                - mode
      responses:
        "200":
          description: Image cropped successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      mode:
                        type: string
              description: Returned when responseMode=base64 (default)
            image/*:
              schema:
                type: string
                format: binary
              description: |
                Returned when responseMode=binary. Raw binary image data with metadata in HTTP headers:
                - Content-Type: image/* (image/png, image/jpeg, etc.)
                - X-Image-Mimetype: image/png (matches Content-Type)
                - X-Image-Format: png
                - X-Image-Mode: manual (or trim)
                - Additional headers for manual mode: X-Image-Width, X-Image-Height, X-Image-X, X-Image-Y
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /optimize:
    post:
      tags:
        - Image Processing
      summary: Optimize image quality and file size
      description: Reduce image file size by adjusting quality and stripping metadata. Output format will match input format.
      parameters:
        - name: responseMode
          in: query
          description: Response format mode
          required: false
          schema:
            type: string
            enum: [base64, binary]
            default: base64
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                image:
                  type: string
                  format: binary
                  description: Image file to optimize
                quality:
                  type: integer
                  minimum: 1
                  maximum: 100
                  description: Quality percentage (lower = smaller file size)
                  example: 70
              required:
                - image
                - quality
      responses:
        "200":
          description: Image optimized successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      quality:
                        type: integer
              description: Returned when responseMode=base64 (default)
            image/*:
              schema:
                type: string
                format: binary
              description: |
                Returned when responseMode=binary. Raw binary image data with metadata in HTTP headers:
                - Content-Type: image/* (image/png, image/jpeg, etc.)
                - X-Image-Mimetype: image/png (matches Content-Type)
                - X-Image-Format: jpg
                - X-Image-Quality: 70
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

tags:
  - name: System
    description: System and health endpoints
  - name: Image Processing
    description: Image manipulation endpoints
